name: Build .deb Package

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential xvfb
          sudo gem install --no-document fpm

          python -m pip install --upgrade pip
          pip install PyQt5 PyQtWebEngine pyinstaller

      - name: Find app.py
        id: find_app
        run: |
          FILE_PATH=$(find . -type f -name "app.py" | head -n 1)
          if [ -z "$FILE_PATH" ]; then
            echo "‚ùå app.py introuvable"
            exit 1
          fi
          echo "‚úÖ Fichier trouv√© : $FILE_PATH"
          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT

      - name: Build executable
        run: |
          pyinstaller --onefile "${{ steps.find_app.outputs.file_path }}"

      - name: Create .deb package with fpm
        run: |
          mkdir -p package/usr/local/bin
          cp dist/* package/usr/local/bin/app

          fpm -s dir -t deb \
            -n mon-appli-pyqt \
            -v 1.0.0 \
            --license "MIT" \
            --description "Une application PyQt5 avec PyQtWebEngine" \
            --maintainer "TonNom <ton.email@example.com>" \
            --url "https://github.com/toncompte/tonrepo" \
            package/=/

      - name: Test if the app runs (headless)
        run: |
          echo "üß™ Test de lancement de l'ex√©cutable..."
          chmod +x dist/*
          timeout 5 xvfb-run -a ./dist/app &> output.log || true

          if grep -q "Traceback" output.log; then
            echo "‚ùå L'ex√©cutable a lev√© une exception."
            cat output.log
            exit 1
          else
            echo "‚úÖ Lancement r√©ussi (aucune exception d√©tect√©e)."
          fi

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: ./*.deb
