name: Build & Test .deb for PyQt App

on:
  push:
    paths:
      - '**.py'
  workflow_dispatch:

jobs:
  build-deb:
runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: ğŸ” Chercher app.py dans tout le dÃ©pÃ´t
        run: |
          APP_FILE=$(find . -name "app.py" | head -n 1)
          if [ -z "$APP_FILE" ]; then
            echo "âŒ Aucun fichier app.py trouvÃ© !"
            exit 1
          fi
          echo "âœ… Fichier trouvÃ© : $APP_FILE"
          echo "APP_PATH=$APP_FILE" >> $GITHUB_ENV

      - name: ğŸ Installer Python et dÃ©pendances
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pyqt5 python3-pyqt5.qtwebengine python3-pip
          pip3 install pyinstaller fpm

      - name: ğŸ”§ Construire l'exÃ©cutable avec PyInstaller
        run: |
          pyinstaller --onefile "$APP_PATH" --name app
          ls -lh dist/

      - name: ğŸ“¦ CrÃ©er le .deb avec FPM
        run: |
          fpm -s dir -t deb -n mon-appli-pyqt -v 1.0.0 \
            --prefix /usr/local/bin \
            dist/app

      - name: ğŸ“ Lister les fichiers gÃ©nÃ©rÃ©s
        run: ls -lh *.deb

      - name: ğŸ§ª Installer le .deb gÃ©nÃ©rÃ©
        run: sudo dpkg -i mon-appli-pyqt_1.0.0_amd64.deb

      - name: ğŸš€ Tester le lancement de l'application
        run: |
          echo "ğŸ§ª Test de lancement de l'exÃ©cutable..."
          /usr/local/bin/app || { echo "âŒ Erreur au lancement"; exit 1; }
          echo "âœ… Lancement rÃ©ussi (aucune exception dÃ©tectÃ©e)."
